# 34道作业题

## 1. 取得每个部门最高薪水的人员名称

需要首先获得每个部门的最高薪水

```mysql
mysql> select deptno, max(sal) as maxsal from emp group by deptno;
+--------+---------+
| deptno | maxsal  |
+--------+---------+
|     20 | 3000.00 |
|     30 | 2850.00 |
|     10 | 5000.00 |
+--------+---------+
3 rows in set (0.00 sec)
```

然后将上述返回结果作为表`t`和表`emp`自身连接，获取部门编号相同并且`emp`中薪水和`t`中薪水相同的记录

```mysql
mysql> select e.ename, t.* from emp e join (select deptno, max(sal) as maxsal from emp group by deptno) t on t.deptno = e.deptno and t.maxsal = e.sal;
+-------+--------+---------+
| ename | deptno | maxsal  |
+-------+--------+---------+
| BLAKE |     30 | 2850.00 |
| SCOTT |     20 | 3000.00 |
| KING  |     10 | 5000.00 |
| FORD  |     20 | 3000.00 |
+-------+--------+---------+
4 rows in set (0.00 sec)
```

## 2. 哪些人的薪水在部门的平均薪水之上

首先获取部门的平均薪水

```mysql
mysql> select deptno, avg(sal) as avgsal from emp group by deptno;
+--------+-------------+
| deptno | avgsal      |
+--------+-------------+
|     20 | 2175.000000 |
|     30 | 1566.666667 |
|     10 | 2916.666667 |
+--------+-------------+
3 rows in set (0.00 sec)
```

上述结果作为`t`，然后连接原表`emp`，判断薪水大于平均薪资

```mysql
mysql> select e.ename, e.sal from emp e join (select deptno, avg(sal) as avgsal from emp group by deptno) t on e.sal > t.avgsal and t.deptno = e.deptno;
+-------+---------+
| ename | sal     |
+-------+---------+
| ALLEN | 1600.00 |
| JONES | 2975.00 |
| BLAKE | 2850.00 |
| SCOTT | 3000.00 |
| KING  | 5000.00 |
| FORD  | 3000.00 |
+-------+---------+
6 rows in set (0.00 sec)
```

## 3. 取得部门中所有人的平均薪水等级

首先获得每个人的薪水等级

```mysql
mysql> select e.ename, e.sal, e.deptno, s.grade from emp e join salgrade s on e.sal between s.losal and s.hisal;
+--------+---------+--------+-------+
| ename  | sal     | deptno | grade |
+--------+---------+--------+-------+
| SMITH  |  800.00 |     20 |     1 |
| ALLEN  | 1600.00 |     30 |     3 |
| WARD   | 1250.00 |     30 |     2 |
| JONES  | 2975.00 |     20 |     4 |
| MARTIN | 1250.00 |     30 |     2 |
| BLAKE  | 2850.00 |     30 |     4 |
| CLARK  | 2450.00 |     10 |     4 |
| SCOTT  | 3000.00 |     20 |     4 |
| KING   | 5000.00 |     10 |     5 |
| TURNER | 1500.00 |     30 |     3 |
| ADAMS  | 1100.00 |     20 |     1 |
| JAMES  |  950.00 |     30 |     1 |
| FORD   | 3000.00 |     20 |     4 |
| MILLER | 1300.00 |     10 |     2 |
+--------+---------+--------+-------+
14 rows in set (0.00 sec)
```

然后将上述表的结果作为临时表`t`，根据部门分组计算平均薪资等级

```mysql
mysql> select t.deptno, avg(t.grade) as avg_grade from (select e.ename, e.sal, e.deptno, s.grade from emp e join salgrade s on e.sal between s.losal and s.hisal) t group by t.deptno order by deptno;
+--------+-----------+
| deptno | avg_grade |
+--------+-----------+
|     10 |    3.6667 |
|     20 |    2.8000 |
|     30 |    2.5000 |
+--------+-----------+
3 rows in set (0.00 sec)
```

## 4. 不准用组函数`max`，取得最高薪水

给出两种方案

* 第一种：`sal`降序排列，第一条记录就是最高薪水

  ```mysql
  mysql> select ename, sal from emp order by sal desc limit 0,1;
  +-------+---------+
  | ename | sal     |
  +-------+---------+
  | KING  | 5000.00 |
  +-------+---------+
  1 row in set (0.00 sec)
  ```

* 第二种：**表的自连接**(没有理解)

  ```mysql
  mysql> select ename, sal from emp where sal not in (select distinct a.sal from emp a join emp b on a.sal < b.sal);
  +-------+---------+
  | ename | sal     |
  +-------+---------+
  | KING  | 5000.00 |
  +-------+---------+
  1 row in set (0.00 sec)
  ```

## 5. 取得平均薪水最高的部门的部门编号

至少给出两种解决方案

* 第一种：直接计算平均薪水，然后按照平均薪水降序排列，获取第一个部门

  ```mysql
  mysql> select deptno, avg(sal) as avgsal from emp group by deptno order by avgsal desc limit 0, 1;
  +--------+-------------+
  | deptno | avgsal      |
  +--------+-------------+
  |     10 | 2916.666667 |
  +--------+-------------+
  1 row in set (0.00 sec)
  ```

* 第二种：同样计算平均薪水，然后通过`max`找到最高平均薪水，然后查找`emp`表中和最高平均薪水相等的部门

  ```mysql
  mysql> select deptno, avg(sal) as avgsal from emp group by deptno having avgsal = (select max(t.avgsal) from (select deptno, avg(sal) as avgsal from emp group by deptno) t);
  +--------+-------------+
  | deptno | avgsal      |
  +--------+-------------+
  |     10 | 2916.666667 |
  +--------+-------------+
  1 row in set (0.00 sec)
  ```

## 6. 取得平均薪水最高的部门的部门名称

通过5题可以得到平均薪水最高的部门，然后通过部门编号从`dept`表中获取对应部门名称

```mysql
mysql> select t.deptno, d.dname from dept d join (select deptno, avg(sal) as avgsal from emp group by deptno order by avgsal desc limit 0, 1) t on t.deptno = d.deptno;
+--------+------------+
| deptno | dname      |
+--------+------------+
|     10 | ACCOUNTING |
+--------+------------+
1 row in set (0.00 sec)
```

## 7. 求平均薪水的等级最低的部门名称

直接可以修改6中答案，将`order by`中的`desc`去掉

```mysql
mysql> select t.deptno, d.dname from dept d join (select deptno, avg(sal) as avgsal from emp group by deptno order by avgsal limit 0, 1) t on t.deptno = d.deptno;
+--------+-------+
| deptno | dname |
+--------+-------+
|     30 | SALES |
+--------+-------+
1 row in set (0.00 sec)
```

## 8. 取得比普通员工（员工代码没有在`mgr`字段上出现的)的最高薪水还要高的领导人姓名

首先需要找到普通员工，查看`mgr`没有出现员工代码的就是普通员工，也可以换而言之，先找在`mgr`出现的，然后判断取反操作获得普通员工

```mysql
mysql> select distinct mgr from emp where mgr is not null;
+------+
| mgr  |
+------+
| 7902 |
| 7698 |
| 7839 |
| 7566 |
| 7788 |
| 7782 |
+------+
6 rows in set (0.00 sec)
```

上述获得管理层员工代码，然后没有在其中出现的代码就是普通员工，这样我们可以得到普通员工的最高工资

```mysql
mysql> select max(sal) from emp where empno not in (select distinct mgr from emp where mgr is not null);
+----------+
| max(sal) |
+----------+
|  1600.00 |
+----------+
1 row in set (0.00 sec)
```

然后获取比该工资还要高的领导人姓名

```mysql
mysql> select ename, sal from emp where sal > (select max(sal) from emp where empno not in (select distinct mgr from emp where mgr is not null));
+-------+---------+
| ename | sal     |
+-------+---------+
| JONES | 2975.00 |
| BLAKE | 2850.00 |
| CLARK | 2450.00 |
| SCOTT | 3000.00 |
| KING  | 5000.00 |
| FORD  | 3000.00 |
+-------+---------+
6 rows in set (0.00 sec)
```

## 9. 取得薪水最高的前五名员工

```mysql
mysql> select ename, sal from emp order by sal desc limit 0, 5;
+-------+---------+
| ename | sal     |
+-------+---------+
| KING  | 5000.00 |
| SCOTT | 3000.00 |
| FORD  | 3000.00 |
| JONES | 2975.00 |
| BLAKE | 2850.00 |
+-------+---------+
5 rows in set (0.00 sec)
```

## 10. 取得薪水最高的第六到第十名员工

```mysql
mysql> select ename, sal from emp order by sal desc limit 5, 5;
+--------+---------+
| ename  | sal     |
+--------+---------+
| CLARK  | 2450.00 |
| ALLEN  | 1600.00 |
| TURNER | 1500.00 |
| MILLER | 1300.00 |
| WARD   | 1250.00 |
+--------+---------+
5 rows in set (0.00 sec)
```









